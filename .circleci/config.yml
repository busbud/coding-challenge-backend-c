version: 2
jobs:
    build_and_test:
        working_directory: ~/city-suggestions
        docker: 
            - image: circleci/node:9-jessie-browsers
        steps:
            - checkout
            - run:
                name: Install npm
                command: 'sudo npm install -g npm@latest'
            - restore_cache: 
                key: dependency-cache-{{ checksum "package.json" }}
            - run:
                name: Install dependencies
                command: npm install
            - save_cache:
                key: dependency-cache-{{ checksum "package.json" }}
                paths:
                    - ./node_modules
            - run:
                name: Run tests
                command: npm test
    deploy:
        working_directory: ~/city-suggestions
        docker: 
            - image: buildpack-deps:trusty
        steps:
            - checkout
            - run:
                name: Deploy Master to Heroku
                command: |
                  git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git

workflows:
    version: 2
    build_branch:
        jobs:
            - build_and_test
            - deploy:
                requires:
                    - build_and_test
                filters:
                    branches:
                        only: master